<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Rapid Suitability (MCDA-lite) — Strathcona County</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    :root { --panel-w: 350px; --fs: 8px; }
    html, body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; font-size:var(--fs); }
    #map   { position:absolute; inset:0 var(--panel-w) 0 0; }
    #panel {
      position:absolute; top:0; right:0; width:var(--panel-w); height:100%;
      background:#fff; border-left:1px solid #ddd; padding:5px 5px; overflow:auto; line-height:1.3;
    }
    h2 { font-size:12px; margin:2px 0 8px; }
    .small { color:#555; font-size:10px; }
    .group { margin:8px 0; }
    label { display:block; margin-bottom:4px; font-weight:600; }
    .row { display:flex; gap:6px; align-items:center; }
    input[type="range"] { width:100%; }
    select, input[type="checkbox"] { font-size:var(--fs); }
    .btn { display:inline-block; padding:5px 5px; background:#016797; color:#fff; border-radius:7px; cursor:pointer; text-decoration:none; }
    .badge { font-size:11px; background:#f0f0f0; padding:1px 5px; border-radius:999px; }
    .muted { color:#777; }
    .ok { color:#0a7; }
    .warn { color:#d70; }
    .err { color:#d33; }
    .hr { height:1px; background:#eee; margin:8px 0; }
    .legend { display:flex; height:10px; margin:4px 0 6px; background:linear-gradient(90deg,#fff7bf,#79bcd7,#0b3c73); border:1px solid #ccc; }
  </style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h2>Rapid Suitability (MCDA-lite)</h2>
  <div class="small">Hex-grid scoring from live ArcGIS GeoJSON. Adjust and click <b>Recompute</b>.</div>

  <div class="group">
    <label>Objective</label>
    <select id="mode">
      <option value="exposure">Population/Exposure (closer to amenities)</option>
      <option value="background">Background/Regional (farther from amenities)</option>
    </select>
  </div>

  <div class="group">
    <label>Roads preference</label>
    <select id="roadsPref">
      <option value="closer">Closer is better (near traffic)</option>
      <option value="farther">Farther is better (background)</option>
    </select>
  </div>

  <div class="group">
    <label>Hex cell size (km)</label>
    <div class="row">
      <input type="range" id="cellkm" min="0.3" max="2.5" step="0.1" value="0.6">
      <span id="cellkm_val" class="badge">0.6</span>
    </div>
  </div>

  <div class="group">
    <label>Distance cap for proximity (km) <span class="small">(linear rescale)</span></label>
    <div class="row">
      <input type="range" id="dmax" min="0.5" max="6" step="0.5" value="3">
      <span id="dmax_val" class="badge">3</span>
    </div>
  </div>

  <div class="group">
    <label>Weights (auto-normalize)</label>
    <div class="row"><span class="small" style="width:100px">Wi-Fi proximity</span><input type="range" id="w_wifi" min="0" max="1" step="0.05" value="0.25"><span id="w_wifi_val" class="badge">0.25</span></div>
    <div class="row"><span class="small" style="width:100px">Amenities proximity</span><input type="range" id="w_amen" min="0" max="1" step="0.05" value="0.25"><span id="w_amen_val" class="badge">0.25</span></div>
    <div class="row"><span class="small" style="width:100px">Roads proximity</span><input type="range" id="w_road" min="0" max="1" step="0.05" value="0.20"><span id="w_road_val" class="badge">0.20</span></div>
    <div class="row"><span class="small" style="width:100px">Land-use score</span><input type="range" id="w_lu" min="0" max="1" step="0.05" value="0.20"><span id="w_lu_val" class="badge">0.20</span></div>
    <div class="row"><span class="small" style="width:100px">Bldg density</span><input type="range" id="w_bld" min="0" max="1" step="0.05" value="0.10"><span id="w_bld_val" class="badge">0.10</span></div>
    <div class="small muted">Sum is normalized to 1.</div>
  </div>

  <div class="group">
    <label><input type="checkbox" id="excludePEMU"> Exclude inside Priority Environmental Mgmt Units</label>
  </div>

  <div class="group">
    <a id="runBtn" class="btn">Recompute</a>
    <span id="status" class="small muted">Loading data…</span>
  </div>

  <div class="group">
    <div class="small"><b>Legend</b> (low → high)</div>
    <div class="legend"></div>
  </div>

  <div class="hr"></div>
  <div class="small">
    Notes: Uses Wi-Fi bldgs, amenities (Playgrounds, Parks, Playing Fields, Splash Parks), Roads, Land-Use, and Building Footprints. Contours are ignored (no slope inference here).
  </div>
</div>

<script>
/* ------------------------- CONFIG / LAYERS ------------------------- */
const URLS = {
  wifi:  'https://services.arcgis.com/B7ZrK1Hv4P1dsm9R/arcgis/rest/services/County_Buildings_with_WiFi/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson',
  play:  'https://services.arcgis.com/B7ZrK1Hv4P1dsm9R/arcgis/rest/services/Playgrounds/FeatureServer/3/query?outFields=*&where=1%3D1&f=geojson',
  parks: 'https://services.arcgis.com/B7ZrK1Hv4P1dsm9R/arcgis/rest/services/Parks/FeatureServer/2/query?outFields=*&where=1%3D1&f=geojson',
  fields:'https://services.arcgis.com/B7ZrK1Hv4P1dsm9R/arcgis/rest/services/Playing_Fields/FeatureServer/5/query?outFields=*&where=1%3D1&f=geojson',
  splash:'https://services.arcgis.com/B7ZrK1Hv4P1dsm9R/arcgis/rest/services/Splash_Parks/FeatureServer/8/query?outFields=*&where=1%3D1&f=geojson',
  bldg:  'https://services.arcgis.com/B7ZrK1Hv4P1dsm9R/arcgis/rest/services/Building_Footprints/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson',
  roads: 'https://services.arcgis.com/B7ZrK1Hv4P1dsm9R/arcgis/rest/services/Street_Network1/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson',
  pemu:  'https://services.arcgis.com/B7ZrK1Hv4P1dsm9R/arcgis/rest/services/Priority_Environment_Management_Units/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson',
  land:  'https://services.arcgis.com/B7ZrK1Hv4P1dsm9R/arcgis/rest/services/Land_Use_Bylaw/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson'
};

// Land-use mapping: adjust keys and scores to your schema
function landUseScore(props) {
  const key = (props.ZONE || props.DISTRICT || props.LAND_USE || props.LANDUSE || props.Zoning || 'default') + '';
  const lut = {
    'Industrial':0.9, 'IND':0.9,
    'Commercial':0.8, 'COM':0.8,
    'Institutional':0.75, 'INS':0.75,
    'Residential':0.6, 'RES':0.6,
    'Park':0.4, 'OPEN SPACE':0.4,
    'Agriculture':0.5,
    'default':0.5
  };
  for (const k of Object.keys(lut)) {
    if (k !== 'default' && key.toLowerCase().includes(k.toLowerCase())) return lut[k];
  }
  return lut['default'];
}

/* --------------------------- UI / MAP ------------------------------ */
const map = L.map('map', { zoomControl:true }).setView([53.53, -113.30], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap'}).addTo(map);

const ui = {
  mode: document.getElementById('mode'),
  roadsPref: document.getElementById('roadsPref'),
  cellkm: document.getElementById('cellkm'),
  cellkm_val: document.getElementById('cellkm_val'),
  dmax: document.getElementById('dmax'),
  dmax_val: document.getElementById('dmax_val'),
  w_wifi: document.getElementById('w_wifi'),
  w_wifi_val: document.getElementById('w_wifi_val'),
  w_amen: document.getElementById('w_amen'),
  w_amen_val: document.getElementById('w_amen_val'),
  w_road: document.getElementById('w_road'),
  w_road_val: document.getElementById('w_road_val'),
  w_lu: document.getElementById('w_lu'),
  w_lu_val: document.getElementById('w_lu_val'),
  w_bld: document.getElementById('w_bld'),
  w_bld_val: document.getElementById('w_bld_val'),
  excludePEMU: document.getElementById('excludePEMU'),
  runBtn: document.getElementById('runBtn'),
  status: document.getElementById('status')
};
function hookRange(inp, lab){ const f=()=>lab.textContent=(+inp.value).toFixed(inp.step.includes('.')?1:0); inp.addEventListener('input',f); f(); }
[['cellkm','cellkm_val'],['dmax','dmax_val'],['w_wifi','w_wifi_val'],['w_amen','w_amen_val'],['w_road','w_road_val'],['w_lu','w_lu_val'],['w_bld','w_bld_val']].forEach(([a,b])=>hookRange(ui[a],ui[b]));

/* --------------------------- DATA LOAD ---------------------------- */
async function fetchAllArcGISGeoJSON(baseUrl, chunk=2000){
  const sep = baseUrl.includes('?') ? '&' : '?'; let offset = 0, all = [];
  while (true) {
    const url = `${baseUrl}${sep}resultOffset=${offset}&resultRecordCount=${chunk}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    const gj = await res.json();
    const feats = gj.features || [];
    all = all.concat(feats);
    if (feats.length < chunk) break;
    offset += feats.length;
  }
  return { type:'FeatureCollection', features:all };
}

let LAYERS = {}; // holds GeoJSON FeatureCollections we use
let hexLayer, topLayer;

async function init(){
  try {
    ui.status.textContent = 'Loading live layers…';
    const [wifi,play,parks,fields,splash,bldg,roads,pemu,land] = await Promise.all([
      fetchAllArcGISGeoJSON(URLS.wifi),
      fetchAllArcGISGeoJSON(URLS.play),
      fetchAllArcGISGeoJSON(URLS.parks),
      fetchAllArcGISGeoJSON(URLS.fields),
      fetchAllArcGISGeoJSON(URLS.splash),
      fetchAllArcGISGeoJSON(URLS.bldg),
      fetchAllArcGISGeoJSON(URLS.roads),
      fetchAllArcGISGeoJSON(URLS.pemu),
      fetchAllArcGISGeoJSON(URLS.land)
    ]);
    // Build amenities by merging multiple point-ish layers (centroids for polys)
    const amenities = {
      type:'FeatureCollection',
      features: []
        .concat(play.features)
        .concat(parks.features.map(f=>turf.centroid(f)))
        .concat(fields.features.map(f=>turf.centroid(f)))
        .concat(splash.features)
    };
    const bldgCentroids = { type:'FeatureCollection', features: bldg.features.map(f=>turf.centroid(f)) };

    LAYERS = { wifi, amenities, bldgPolys: bldg, bldgCentroids, roads, pemu, land };

    // Fit to land-use bbox
    try { const bb = turf.bbox(land); map.fitBounds([[bb[1],bb[0]],[bb[3],bb[2]]], {padding:[15,15]}); } catch {}

    ui.status.textContent = 'Ready. Click Recompute.';
  } catch (e) {
    console.error(e);
    ui.status.innerHTML = `<span class="err">Failed to load data: ${e.message}</span>`;
  }
}

/* --------------------------- SCORING ------------------------------ */
function recompute(){
  if (!LAYERS.land) { ui.status.innerHTML = '<span class="warn">Data not loaded yet…</span>'; return; }
  ui.status.innerHTML = '<span class="muted">Computing…</span>';

  if (hexLayer) map.removeLayer(hexLayer);
  if (topLayer) map.removeLayer(topLayer);

  const cellKm = +ui.cellkm.value;
  const dMax   = +ui.dmax.value;
  const mode   = ui.mode.value;                 // exposure | background
  const roadsPref = ui.roadsPref.value;         // closer | farther
  const excludePEMU = ui.excludePEMU.checked;

  // Weights normalized
  let w = {
    wifi:+ui.w_wifi.value, amen:+ui.w_amen.value, road:+ui.w_road.value, lu:+ui.w_lu.value, bld:+ui.w_bld.value
  };
  const sum = Object.values(w).reduce((a,b)=>a+b,0) || 1;
  Object.keys(w).forEach(k => w[k]=w[k]/sum);

  const { wifi, amenities, bldgCentroids, roads, pemu, land } = LAYERS;

  // Hex grid over land-use bbox
  const bbox = turf.bbox(land);
  const hex = turf.hexGrid(bbox, cellKm, { units:'kilometers' });

  // For each hex center compute criteria
  const raw = [];
  let maxBldDen = 0;
  for (const cell of hex.features) {
    const center = turf.centerOfMass(cell);

    const dWifi = distanceToFeaturesKm(center, wifi);
    const dAmen = distanceToFeaturesKm(center, amenities);
    const dRoad = distanceToRoadsKm(center, roads); // line distance

    // bldg density in 0.1 km buffer
    const ring = turf.circle(center, 0.1, {steps:16, units:'kilometers'});
    const dens = turf.pointsWithinPolygon(bldgCentroids, ring).features.length;
    if (dens > maxBldDen) maxBldDen = dens;

    // land-use: point-in-polygon score (fallback nearest poly centroid)
    const lu = landUseAtPoint(center, land);

    // optional constraint mask
    let allowed = 1;
    if (excludePEMU && pointInAnyPolygon(center, pemu)) allowed = 0;

    raw.push({ cell, center, dWifi, dAmen, dRoad, dens, lu, allowed });
  }

  // Scale to 0–1 and combine
  const denMax = Math.max(1, maxBldDen);
  for (const r of raw) {
    const s_wifi = clamp(1 - (r.dWifi / dMax), 0, 1);                     // closer better
    const s_amen = (mode === 'exposure') ? clamp(1 - (r.dAmen / dMax),0,1)
                                         : clamp(  (r.dAmen / dMax),0,1); // farther better
    const s_road = (roadsPref === 'closer') ? clamp(1 - (r.dRoad / dMax),0,1)
                                            : clamp(  (r.dRoad / dMax),0,1);
    const s_bld  = clamp(r.dens / denMax, 0, 1);
    const s_lu   = clamp(r.lu, 0, 1);

    r.scoreRaw = w.wifi*s_wifi + w.amen*s_amen + w.road*s_road + w.lu*s_lu + w.bld*s_bld;
    r.score    = r.scoreRaw * r.allowed; // apply constraint
  }

  // Color ramp
  const minS = Math.min(...raw.map(r=>r.score));
  const maxS = Math.max(...raw.map(r=>r.score));
  function colorFor(s){
    const t = (s - minS) / (maxS - minS + 1e-9);
    return `hsl(${200 - 160*t}, ${30 + 40*t}%, ${85 - 45*t}%)`; // light yellow -> teal -> dark blue
  }

  // Paint hexes
  hex.features.forEach((f,i)=>{ f.properties = { score:+raw[i].score.toFixed(3) }; });
  hexLayer = L.geoJSON(hex, {
    style: f => ({ color:'#aaa', weight:0.4, fillColor:colorFor(f.properties.score), fillOpacity:0.78 }),
    onEachFeature:(f,lyr)=>{
      lyr.bindPopup(`<b>Suitability</b>: ${f.properties.score}`);
    }
  }).addTo(map);

  // Top 10 candidates
  const sorted = raw.filter(r=>r.allowed===1).sort((a,b)=>b.score-a.score).slice(0,10);
  const topFC = { type:'FeatureCollection', features: sorted.map(r=>({
    type:'Feature', properties:{score:+r.score.toFixed(3)}, geometry:r.center.geometry
  }))};
  topLayer = L.geoJSON(topFC, {
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:6,weight:2,color:'#fe0002',fillColor:'#fff',fillOpacity:1})
      .bindPopup(`<b>Candidate</b><br>Score: ${f.properties.score}`)
  }).addTo(map);
  topLayer.bringToFront();

  ui.status.innerHTML = `<span class="ok">Done. Cells: ${hex.features.length}, Top10 shown.</span>`;
}

/* --------------------------- HELPERS ------------------------------- */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

function centroidOrPoint(f) {
  // Return a Point feature for distance calcs
  const g = f.geometry;
  if (!g) return null;
  if (g.type === 'Point') return f;
  return turf.centroid(f);
}

function distanceToFeaturesKm(pt, fc){
  if (!fc.features.length) return 999;
  let min = Infinity;
  for (const f of fc.features) {
    const pf = centroidOrPoint(f);
    if (!pf) continue;
    const d = turf.distance(pt, pf, {units:'kilometers'});
    if (d < min) min = d;
  }
  return min;
}

function distanceToRoadsKm(pt, fc){
  if (!fc.features.length) return 999;
  let min = Infinity;
  for (const f of fc.features) {
    const g = f.geometry;
    if (!g) continue;
    if (g.type === 'LineString' || g.type === 'MultiLineString') {
      const d = turf.pointToLineDistance(pt, f, {units:'kilometers'});
      if (d < min) min = d;
    } else {
      // fallback to centroid distance (if any non-line sneaks in)
      const d = turf.distance(pt, centroidOrPoint(f), {units:'kilometers'});
      if (d < min) min = d;
    }
  }
  return min;
}

function landUseAtPoint(pt, polysFC){
  for (const f of polysFC.features) {
    if (turf.booleanPointInPolygon(pt, f)) return landUseScore(f.properties||{});
  }
  // fallback: nearest polygon centroid
  if (!polysFC.features.length) return 0.5;
  let best = 0.5, min = Infinity;
  for (const f of polysFC.features) {
    const d = turf.distance(pt, turf.centroid(f), {units:'kilometers'});
    if (d < min) { min = d; best = landUseScore(f.properties||{}); }
  }
  return best;
}
function pointInAnyPolygon(pt, polysFC){
  for (const f of polysFC.features) if (turf.booleanPointInPolygon(pt, f)) return true;
  return false;
}

/* --------------------------- WIRE UP ------------------------------- */
ui.runBtn.addEventListener('click', recompute);
init();
</script>
</body>
</html>
